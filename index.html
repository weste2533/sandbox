<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fund Data Loader</title>
    <script src="fund-distribution-parser.js" defer></script> 
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background-color: #f5f5f5; }
        #container { max-width: 1000px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #debug { font-family: monospace; white-space: pre-wrap; background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 4px; max-height: 400px; overflow: auto; }
        
        /* Tab Styles */
        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 4px;
            background-color: #f8f8f8;
        }
        .tab.active {
            border-color: #ddd;
            background-color: white;
            font-weight: bold;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Chart Styles */
        .chart-container {
            width: 100%;
            height: 300px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Mutual Fund Data Loader</h1>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <div class="tab active" data-tab="debug">Debug</div>
            <div class="tab" data-tab="afaxx">AFAXX Distributions</div>
            <div class="tab" data-tab="agthx">AGTHX Data</div>
            <div class="tab" data-tab="ancfx">ANCFX Data</div>
        </div>
        
        <!-- Tab Content -->
        <div id="debug-tab" class="tab-content active">
            <div id="debug">Debug Output:</div>
        </div>
        
        <div id="afaxx-tab" class="tab-content">
            <h2>AFAXX Historical Distribution Data</h2>
            <div class="chart-container" id="afaxx-chart"></div>
            <table id="afaxx-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Distribution data will be populated here -->
                </tbody>
            </table>
        </div>
        
        <div id="agthx-tab" class="tab-content">
            <h2>AGTHX NAV and Distribution Data</h2>
            <div class="chart-container" id="agthx-chart"></div>
            <h3>NAV History</h3>
            <table id="agthx-nav-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>NAV</th>
                        <th>Change</th>
                    </tr>
                </thead>
                <tbody id="agthx-nav-tbody">
                    <!-- NAV data will be populated here -->
                </tbody>
            </table>
            
            <h3>Distribution History</h3>
            <table id="agthx-dist-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="agthx-dist-tbody">
                    <!-- Distribution data will be populated here -->
                </tbody>
            </table>
        </div>
        
        <div id="ancfx-tab" class="tab-content">
            <h2>ANCFX NAV and Distribution Data</h2>
            <div class="chart-container" id="ancfx-chart"></div>
            <h3>NAV History</h3>
            <table id="ancfx-nav-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>NAV</th>
                        <th>Change</th>
                    </tr>
                </thead>
                <tbody id="ancfx-nav-tbody">
                    <!-- NAV data will be populated here -->
                </tbody>
            </table>
            
            <h3>Distribution History</h3>
            <table id="ancfx-dist-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="ancfx-dist-tbody">
                    <!-- Distribution data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const FUNDS = ['ANCFX', 'AGTHX', 'AFAXX'];
        const PROXIES = [
            "https://corsproxy.io/?", 
            "https://api.allorigins.win/get?url=",
            "https://thingproxy.freeboard.io/fetch/",
            "https://cors-anywhere.herokuapp.com/",
            "https://crossorigin.me/",
            "https://yacdn.org/serve/",
            "https://api.codetabs.com/v1/proxy/?quest="
        ];
        let debugLog = [];
        let allFundData = {};

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });

        async function fetchWithRetry(url, maxAttempts = 3, initialDelay = 1000) {
            for (let proxyIndex = 0; proxyIndex < PROXIES.length; proxyIndex++) {
                const proxyUrl = PROXIES[proxyIndex] + encodeURIComponent(url);
                
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    try {
                        const start = Date.now();
                        debugLog.push(`üîµ Proxy ${proxyIndex + 1}/${PROXIES.length} - Attempt ${attempt + 1}/${maxAttempts}\nURL: ${proxyUrl}`);
                        
                        const response = await fetch(proxyUrl, { cache: 'no-cache' });
                        const latency = Date.now() - start;
                        debugLog.push(`Status: ${response.status} ‚Ä¢ Latency: ${latency}ms`);

                        if (!response.ok) {
                            throw new Error(`HTTP error: ${response.status}`);
                        }

                        const text = await response.text();
                        try {
                            return JSON.parse(text).contents || text;
                        } catch {
                            return text;
                        }
                    } catch (error) {
                        debugLog.push(`üî¥ Proxy ${proxyIndex + 1} - Attempt ${attempt + 1} error: ${error.message}`);
                        if (attempt < maxAttempts - 1) {
                            const delay = initialDelay * Math.pow(2, attempt);
                            debugLog.push(`‚è±Ô∏è Waiting ${delay}ms before retry...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
            }
            throw new Error('All proxies and retry attempts failed');
        }

        async function fetchYahooFinanceData(fund) {
            const startDate = new Date('2024-01-01');
            const endDate = new Date();
            endDate.setDate(endDate.getDate() - 1);
            const period1 = Math.floor(startDate.getTime() / 1000);
            const period2 = Math.floor(endDate.getTime() / 1000);

            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${fund}?period1=${period1}&period2=${period2}&interval=1d`;

            try {
                const data = await fetchWithRetry(url);
                debugLog.push(`‚úÖ Fetched ${fund} data from Yahoo Finance.`);
                return data.chart?.result?.[0] || null;
            } catch (error) {
                debugLog.push(`‚ö†Ô∏è Error fetching ${fund} data: ${error.message}`);
                return null;
            }
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function displayNavData(fund, tableId) {
            const tbody = document.getElementById(tableId + "-tbody") || document.querySelector(`#${tableId} tbody`);
            if (!tbody) {
                console.error(`Cannot find tbody for ${tableId}`);
                return;
            }
            
            const fundData = allFundData[fund];
            if (!fundData || !fundData.timestamp || !fundData.indicators?.quote?.[0]?.close) {
                tbody.innerHTML = '<tr><td colspan="3">No data available</td></tr>';
                return;
            }
            
            const timestamps = fundData.timestamp;
            const prices = fundData.indicators.quote[0].close;
            
            let tableHTML = '';
            for (let i = 0; i < timestamps.length; i++) {
                if (prices[i] === null || prices[i] === undefined) continue;
                
                const change = i > 0 && prices[i-1] !== null ? 
                    ((prices[i] - prices[i-1]) / prices[i-1] * 100).toFixed(2) + '%' : 'N/A';
                
                tableHTML += `<tr>
                    <td>${formatDate(timestamps[i])}</td>
                    <td>$${prices[i].toFixed(2)}</td>
                    <td>${change}</td>
                </tr>`;
            }
            
            tbody.innerHTML = tableHTML || '<tr><td colspan="3">No data available</td></tr>';
            debugLog.push(`üîÑ Updated NAV table for ${fund}`);
        }

        function displayDistributionData(fund, tableId) {
            const tbody = document.getElementById(tableId + "-tbody") || document.querySelector(`#${tableId} tbody`);
            if (!tbody) {
                console.error(`Cannot find tbody for ${tableId}`);
                return;
            }
            
            const distributions = allFundData.distributions;
            if (!distributions || !distributions[fund] || !distributions[fund].length) {
                tbody.innerHTML = '<tr><td colspan="3">No distribution data available</td></tr>';
                return;
            }
            
            const fundDistributions = distributions[fund];
            let tableHTML = '';
            
            fundDistributions.forEach(dist => {
                tableHTML += `<tr>
                    <td>${dist.date}</td>
                    <td>${dist.type}</td>
                    <td>$${parseFloat(dist.amount).toFixed(4)}</td>
                </tr>`;
            });
            
            tbody.innerHTML = tableHTML || '<tr><td colspan="3">No distribution data available</td></tr>';
            debugLog.push(`üîÑ Updated distribution table for ${fund}`);
        }

        function updateUI() {
            // Update debug log display
            document.getElementById('debug').textContent = debugLog.join('\n\n');
            
            // Display AFAXX distribution data
            if (allFundData.distributions && allFundData.distributions.AFAXX) {
                const afaxxTable = document.querySelector('#afaxx-table tbody');
                if (afaxxTable) {
                    let afaxxHTML = '';
                    
                    allFundData.distributions.AFAXX.forEach(dist => {
                        afaxxHTML += `<tr>
                            <td>${dist.date}</td>
                            <td>${dist.type}</td>
                            <td>$${parseFloat(dist.amount).toFixed(4)}</td>
                        </tr>`;
                    });
                    
                    afaxxTable.innerHTML = afaxxHTML || '<tr><td colspan="3">No distribution data available</td></tr>';
                    debugLog.push(`üîÑ Updated AFAXX distribution table`);
                }
            }
            
            // Display AGTHX data
            displayNavData('AGTHX', 'agthx-nav');
            displayDistributionData('AGTHX', 'agthx-dist');
            
            // Display ANCFX data
            displayNavData('ANCFX', 'ancfx-nav');
            displayDistributionData('ANCFX', 'ancfx-dist');
            
            // Update the debug display again to show the UI update logs
            document.getElementById('debug').textContent = debugLog.join('\n\n');
        }

        async function loadAllFundsData() {
            debugLog.push("üöÄ Starting data retrieval...");

            // Fetch fund data
            for (let fund of FUNDS) {
                debugLog.push(`üìä Fetching data for ${fund}...`);
                let result = await fetchYahooFinanceData(fund);
                if (result) {
                    allFundData[fund] = result;
                    debugLog.push(`‚úÖ Successfully loaded data for ${fund}`);
                }
            }

            // Load distributions
            try {
                debugLog.push(`üìä Loading distribution data...`);
                const distributions = await loadFundDistributionData('distributions.txt');
                debugLog.push(`‚úÖ Successfully loaded distributions from distributions.txt.`);
                allFundData['distributions'] = distributions;
                
                // Log what funds we have distribution data for
                const fundKeys = Object.keys(distributions);
                debugLog.push(`üìà Found distribution data for: ${fundKeys.join(', ')}`);
                
                // Check each fund for data
                for (const fund of FUNDS) {
                    if (distributions[fund]) {
                        debugLog.push(`${fund}: ${distributions[fund].length} distribution records found`);
                    } else {
                        debugLog.push(`${fund}: No distribution records found`);
                    }
                }
            } catch (error) {
                debugLog.push(`‚ö†Ô∏è Error loading distributions: ${error.message}`);
            }

            // Update UI with the retrieved data
            debugLog.push(`üîÑ Updating UI with retrieved data...`);
            updateUI();
            
            // Log the complete data object for debugging
            console.log('All fund data:', allFundData);
        }

        window.onload = loadAllFundsData;
    </script>
</body>
</html>
