<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fund Data Loader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
            background-color: #f5f5f5;
        }
        #container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #loading {
            text-align: center;
            padding: 1rem;
            color: #666;
        }
        #error {
            color: #dc3545;
            padding: 1rem;
            border: 1px solid #dc3545;
            margin: 1rem 0;
            border-radius: 4px;
            display: none;
        }
        #debug {
            font-family: monospace;
            white-space: pre-wrap;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            max-height: 400px;
            overflow: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
        }
        .action-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
        }
        button {
            padding: 0.5rem 1rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0069d9;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .filters {
            margin: 1rem 0;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .filters label {
            font-weight: bold;
        }
        .filters input[type="date"] {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #summary {
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #e9f7fd;
            border-radius: 4px;
            color: #0069d9;
        }
        .retry-button {
            background-color: #28a745;
        }
        .retry-button:hover {
            background-color: #218838;
        }
        .fund-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s;
        }
        /* Tab styles */
        .tabs {
            margin-top: 2rem;
            border-bottom: 1px solid #dee2e6;
        }
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: -1px;
        }
        .tab-button {
            padding: 0.75rem 1.25rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tab-button:hover {
            background-color: #e9ecef;
        }
        .tab-button.active {
            background-color: white;
            border-bottom: 2px solid white;
            font-weight: bold;
            color: #007bff;
        }
        .tab-content {
            display: none;
            padding: 1.5rem 0;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Mutual Fund Data Loader</h1>
        <div id="loading">🚀 Initializing...</div>
        <div id="error"></div>
        <div id="summary" style="display:none;"></div>
        <div class="progress-container" id="progressContainer" style="display:none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="fundStatus" style="margin-top: 1rem; display:none;"></div>
        <div id="filters" class="filters" style="display:none;">
            <label for="startDateFilter">Show Data From:</label>
            <input type="date" id="startDateFilter">
            <button id="applyFilter">Apply Filter</button>
            <button id="resetFilter">Reset Filter</button>
            
            <label for="textFileUrl" style="margin-left: 1rem;">Distribution Data URL:</label>
            <input type="text" id="textFileUrl" placeholder="distributions.txt" value="distributions.txt" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
            <button id="loadDistributionsBtn">Load Distribution Data</button>
        </div>
        <div id="debug"></div>

        <!-- Tab navigation -->
        <div class="tabs" id="fundTabs" style="display:none;">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="yahooData">Yahoo Finance Data</button>
                <button class="tab-button" data-tab="ancfx">ANCFX</button>
                <button class="tab-button" data-tab="agthx">AGTHX</button>
                <button class="tab-button" data-tab="afaxx">AFAXX</button>
            </div>
            
            <!-- Yahoo Finance data tab -->
            <div class="tab-content active" id="yahooData">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>ANCFX NAV</th>
                            <th>ANCFX Distribution</th>
                            <th>AGTHX NAV</th>
                            <th>AGTHX Distribution</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <!-- ANCFX tab -->
            <div class="tab-content" id="ancfx">
                <h2>ANCFX Distributions</h2>
                <div id="ancfxContent">
                    <p>Load distribution data to view ANCFX details.</p>
                </div>
            </div>
            
            <!-- AGTHX tab -->
            <div class="tab-content" id="agthx">
                <h2>AGTHX Distributions</h2>
                <div id="agthxContent">
                    <p>Load distribution data to view AGTHX details.</p>
                </div>
            </div>
            
            <!-- AFAXX tab -->
            <div class="tab-content" id="afaxx">
                <h2>AFAXX Rates</h2>
                <div id="afaxxContent">
                    <p>Load distribution data to view AFAXX rates.</p>
                </div>
            </div>
        </div>
        
        <div class="action-buttons" id="buttonContainer" style="display:none;">
            <button id="downloadBtn">Download Table as HTML</button>
            <button id="retryBtn" class="retry-button" style="display:none;">Retry Failed Funds</button>
        </div>
    </div>

    <script>
        // More reliable proxy list (expanded)
        const PROXIES = [
            "https://corsproxy.io/?", 
            "https://api.allorigins.win/get?url=",
            "https://thingproxy.freeboard.io/fetch/",
            "https://cors-anywhere.herokuapp.com/",
            "https://crossorigin.me/",
            "https://yacdn.org/serve/",
            "https://api.codetabs.com/v1/proxy/?quest="
        ];

        const FUNDS = ['ANCFX', 'AGTHX'];
        let debugLog = [];
        let fundData = {}; // Object to store data by date for each fund
        let currentFilterStartDate = null;
        let fundStatus = {}; // Track loading status for each fund
        let failedFunds = []; // Track which funds failed to load
        let distributionData = null; // Store parsed distribution data

        // Initialize fund status
        FUNDS.forEach(fund => {
            fundStatus[fund] = { status: 'pending', attempts: 0 };
        });

        /**
         * Loads and parses fund distribution data from a text file
         * @param {string} fileUrl - URL of the distributions text file to load
         * @returns {Promise<Object>} - Promise resolving to an object containing the parsed fund data
         */
        function loadFundDistributionData(fileUrl) {
            return new Promise((resolve, reject) => {
                fetch(fileUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch file: ${response.status} ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(data => {
                        const result = parseDistributionData(data);
                        resolve(result);
                    })
                    .catch(error => {
                        reject(error);
                    });
            });
        }

        /**
         * Parses the distribution data text content
         * @param {string} data - Raw text content from the distributions file
         * @returns {Object} - Object containing parsed fund data
         */
        function parseDistributionData(data) {
            const lines = data.trim().split('\n');
            
            let currentFund = null;
            let isHeader = false;
            let headers = [];
            
            const fundData = {
                ANCFX: {
                    distributions: [],
                    headers: []
                },
                AGTHX: {
                    distributions: [],
                    headers: []
                },
                AFAXX: {
                    rates: []
                }
            };
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Skip empty lines
                if (line === '') continue;
                
                // Detect fund
                if (line === 'ANCFX') {
                    currentFund = 'ANCFX';
                    isHeader = true;
                    continue;
                } else if (line === 'AGTHX') {
                    currentFund = 'AGTHX';
                    isHeader = true;
                    continue;
                } else if (line === 'AFAXX') {
                    currentFund = 'AFAXX';
                    isHeader = true;
                    continue;
                }
                
                // Process headers
                if (isHeader) {
                    headers = line.split('\t');
                    if (currentFund === 'ANCFX' || currentFund === 'AGTHX') {
                        fundData[currentFund].headers = headers;
                    }
                    isHeader = false;
                    continue;
                }
                
                // Process data rows
                const values = line.split('\t');
                
                if (currentFund === 'ANCFX' || currentFund === 'AGTHX') {
                    if (values.length === headers.length) {
                        // Create object with header keys and row values
                        const rowObj = {};
                        headers.forEach((header, index) => {
                            rowObj[header] = values[index];
                        });
                        fundData[currentFund].distributions.push(rowObj);
                    }
                } else if (currentFund === 'AFAXX') {
                    if (values.length === 2) {
                        fundData[currentFund].rates.push({
                            rate: values[0],
                            date: values[1]
                        });
                    }
                }
            }
            
            return fundData;
        }

        /**
         * Formats a date string from MM/DD/YY to MM/DD/YYYY
         * @param {string} dateString - Date string in MM/DD/YY format
         * @returns {string} - Formatted date string
         */
        function formatDate(dateString) {
            // Check if date is in MM/DD/YY format and convert to MM/DD/YYYY if needed
            const parts = dateString.split('/');
            if (parts.length === 3 && parts[2].length === 2) {
                const year = parts[2].startsWith('0') ? '20' + parts[2] : '20' + parts[2];
                return `${parts[0]}/${parts[1]}/${year}`;
            }
            return dateString;
        }

        // Add exponential backoff retry logic
        async function fetchWithRetry(url, maxAttempts = 3, initialDelay = 1000) {
            for (let proxyIndex = 0; proxyIndex < PROXIES.length; proxyIndex++) {
                const proxyUrl = PROXIES[proxyIndex] + encodeURIComponent(url);
                
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    try {
                        const start = Date.now();
                        debugLog.push(
                            `🔵 Proxy ${proxyIndex + 1}/${PROXIES.length} - Attempt ${attempt + 1}/${maxAttempts}\n` +
                            `URL: ${proxyUrl}`
                        );
                        
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                            },
                            cache: 'no-cache'
                        });
                        
                        const latency = Date.now() - start;
                        debugLog.push(`Status: ${response.status} • Latency: ${latency}ms`);

                        if (!response.ok) {
                            throw new Error(`HTTP error: ${response.status}`);
                        }

                        // Try to handle different response formats
                        let data;
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            data = await response.json();
                        } else {
                            const text = await response.text();
                            try {
                                data = JSON.parse(text);
                            } catch (e) {
                                data = text;
                            }
                        }
                        
                        return data.contents || data;
                    } catch (error) {
                        debugLog.push(`🔴 Proxy ${proxyIndex + 1} - Attempt ${attempt + 1} error: ${error.message}`);
                        
                        // If this is not the last attempt, wait before retrying
                        if (attempt < maxAttempts - 1) {
                            const delay = initialDelay * Math.pow(2, attempt);
                            debugLog.push(`⏱️ Waiting ${delay}ms before retry...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
            }
            throw new Error('All proxies and retry attempts failed');
        }

        // Helper function to update progress
        function updateProgress() {
            const total = FUNDS.length * 2; // NAV and dividend data for each fund
            let completed = 0;
            
            // Count completed operations
            FUNDS.forEach(fund => {
                if (fundStatus[fund].navLoaded) completed++;
                if (fundStatus[fund].divLoaded) completed++;
            });
            
            const percentage = Math.round((completed / total) * 100);
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }

        // Update the fund status display
        function updateFundStatusDisplay() {
            const statusDiv = document.getElementById('fundStatus');
            statusDiv.innerHTML = '';
            
            FUNDS.forEach(fund => {
                const status = fundStatus[fund];
                let statusClass = 'status-pending';
                let statusText = 'Pending';
                
                if (status.status === 'success') {
                    statusClass = 'status-success';
                    statusText = 'Loaded';
                } else if (status.status === 'error') {
                    statusClass = 'status-error';
                    statusText = `Failed (${status.attempts} attempts)`;
                } else if (status.status === 'loading') {
                    statusText = 'Loading...';
                }
                
                statusDiv.innerHTML += `
                    <div>
                        <strong>${fund}</strong>
                        <span class="fund-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            });
            
            statusDiv.style.display = 'block';
        }

        async function loadFundData(fund, isRetry = false) {
            try {
                if (!isRetry) {
                    fundStatus[fund] = { status: 'loading', attempts: 0, navLoaded: false, divLoaded: false };
                }
                
                fundStatus[fund].attempts++;
                updateFundStatusDisplay();
                updateLoading(`Fetching ${fund} data (Attempt ${fundStatus[fund].attempts})...`);
                
                // Calculate date range (Jan 1, 2024 to yesterday)
                const startDate = new Date('2024-01-01');
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - 1);
                const period1 = Math.floor(startDate.getTime() / 1000);
                const period2 = Math.floor(endDate.getTime() / 1000);

                // Try to fetch NAV data with multiple attempts
                let navSuccess = false;
                try {
                    // Fetch NAV data
                    const navUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${fund}?period1=${period1}&period2=${period2}&interval=1d`;
                    let navResponse = await fetchWithRetry(navUrl, 3, 1000);
                    
                    // Ensure navResponse is properly parsed
                    let navParsed;
                    if (typeof navResponse === 'string') {
                        try {
                            navParsed = JSON.parse(navResponse);
                        } catch (error) {
                            debugLog.push(`⚠️ Failed to parse NAV response for ${fund}: ${error.message}`);
                            debugLog.push(`Response sample: ${navResponse.substring(0, 100)}...`);
                            throw new Error(`Failed to parse NAV data for ${fund}`);
                        }
                    } else {
                        navParsed = navResponse;
                    }
                    
                    if (!navParsed.chart?.result?.length) {
                        debugLog.push(`⚠️ No NAV data available for ${fund}`);
                        throw new Error(`No NAV data available for ${fund}`);
                    }

                    const result = navParsed.chart.result[0];
                    const timestamps = result.timestamp;
                    const closes = result.indicators.quote[0].close;

                    // Process NAV data
                    timestamps.forEach((ts, i) => {
                        const date = new Date(ts * 1000).toISOString().split('T')[0];
                        if (!fundData[date]) {
                            fundData[date] = {};
                        }
                        
                        fundData[date][`${fund}_nav`] = closes[i] ? closes[i].toFixed(2) : null;
                    });

                    fundStatus[fund].navLoaded = true;
                    navSuccess = true;
                    debugLog.push(`✅ ${fund} NAV data retrieved. Timestamps: ${timestamps.length}`);
                } catch (error) {
                    debugLog.push(`⚠️ Error loading NAV data for ${fund}: ${error.message}`);
                }

                // Try to fetch dividend data independently from NAV data
                let divSuccess = false;
                try {
                    // Fetch dividend data with multiple retries
                    const divUrl = `https://query1.finance.yahoo.com/v7/finance/download/${fund}?period1=${period1}&period2=${period2}&events=div`;
                    const divResponse = await fetchWithRetry(divUrl, 3, 1000);
                    
                    // Process dividend data
                    let divText;
                    if (typeof divResponse === 'string') {
                        divText = divResponse;
                    } else if (divResponse.contents) {
                        divText = divResponse.contents;
                    }

                    if (divText) {
                        const dividends = {};
                        divText.split('\n').slice(1).forEach(row => {
                            if (row) {
                                const [date, amount] = row.split(',');
                                if (date && amount) dividends[date] = parseFloat(amount).toFixed(3);
                            }
                        });

                        // Store dividend data
                        Object.keys(dividends).forEach(date => {
                            if (!fundData[date]) {
                                fundData[date] = {};
                            }
                            fundData[date][`${fund}_div`] = dividends[date];
                        });

                        fundStatus[fund].divLoaded = true;
                        divSuccess = true;
                        debugLog.push(`✅ ${fund} dividend data retrieved. Entries: ${Object.keys(dividends).length}`);
                    } else {
                        debugLog.push(`ℹ️ No dividend data found for ${fund}`);
                        fundStatus[fund].divLoaded = true;
                        divSuccess = true;
                    }
                } catch (error) {
                    debugLog.push(`⚠️ Error loading dividend data for ${fund}: ${error.message}`);
                }

                // Update fund status based on overall success
                if (navSuccess && divSuccess) {
                    fundStatus[fund].status = 'success';
                    // Remove from failed funds list if it was there
                    failedFunds = failedFunds.filter(f => f !== fund);
                } else {
                    // If either NAV or dividend data failed, consider it an error
                    // but keep any partial data we might have received
                    fundStatus[fund].status = 'error';
                    if (!failedFunds.includes(fund)) {
                        failedFunds.push(fund);
                    }
                }

                updateFundStatusDisplay();
                updateProgress();

            } catch (error) {
                debugLog.push(`⚠️ Critical error processing ${fund}: ${error.message}`);
                fundStatus[fund].status = 'error';
                if (!failedFunds.includes(fund)) {
                    failedFunds.push(fund);
                }
                updateFundStatusDisplay();
                updateProgress();
            }
        }

        function generateTableRows(startDate = null) {
            // Get all dates and sort them in descending order
            let dates = Object.keys(fundData).sort((a, b) => new Date(b) - new Date(a));
            
            // Filter dates if startDate is provided
            if (startDate) {
                const startDateObj = new Date(startDate);
                dates = dates.filter(date => new Date(date) >= startDateObj);
            }
            
            // Generate the table rows
            return dates.map(date => {
                const data = fundData[date] || {};
                return `<tr>
                    <td>${date}</td>
                    <td>${data.ANCFX_nav ? '$' + data.ANCFX_nav : 'N/A'}</td>
                    <td>${data.ANCFX_div ? '$' + data.ANCFX_div : '-'}</td>
                    <td>${data.AGTHX_nav ? '$' + data.AGTHX_nav : 'N/A'}</td>
                    <td>${data.AGTHX_div ? '$' + data.AGTHX_div : '-'}</td>
                </tr>`;
            });
        }

        function updateTable(startDate = null) {
            currentFilterStartDate = startDate;
            const rows = generateTableRows(startDate);
            
            document.getElementById('tableBody').innerHTML = rows.join('');
            
            // Update summary
            const summaryElement = document.getElementById('summary');
            if (rows.length === 0) {
                summaryElement.textContent = 'No data found for the selected date range.';
            } else {
                const dateRange = startDate ? 
                    `${startDate} to ${new Date().toISOString().split('T')[0]}` : 
                    `All available data (${Object.keys(fundData).length} days)`;
                
                // Add information about loaded and failed funds
                const loadedFunds = FUNDS.filter(fund => fundStatus[fund].status === 'success').length;
                const failedFundsCount = failedFunds.length;
                
                summaryElement.textContent = `Showing ${rows.length} days of data • Range: ${dateRange} • Funds loaded: ${loadedFunds}/${FUNDS.length}`;
                if (failedFundsCount > 0) {
                    summaryElement.textContent += ` • ${failedFundsCount} fund(s) failed to load completely`;
                    document.getElementById('retryBtn').style.display = 'block';
                } else {
                    document.getElementById('retryBtn').style.display = 'none';
                }
            }
            summaryElement.style.display = 'block';
        }

        // Function to render distribution data in tabs
        function renderDistributionTabs(data) {
            if (!data) return;
            
            // Render ANCFX tab
            const ancfxTable = document.createElement('table');
            const ancfxHeaders = data.ANCFX.headers;
            
            let ancfxHeadersHTML = '<tr>';
            ancfxHeaders.forEach(header => {
                ancfxHeadersHTML += `<th>${header}</th>`;
            });
            ancfxHeadersHTML += '</tr>';
            
            let ancfxRowsHTML = '';
            data.ANCFX.distributions.forEach(dist => {
                let rowHTML = '<tr>';
                ancfxHeaders.forEach(header => {
                    rowHTML += `<td>${dist[header] || '-'}</td>`;
                });
                rowHTML += '</tr>';
                ancfxRowsHTML += rowHTML;
            });
            
            ancfxTable.innerHTML = `<thead>${ancfxHeadersHTML}</thead><tbody>${ancfxRowsHTML}</tbody>`;
            document.getElementById('ancfxContent').innerHTML = '';
            document.getElementById('ancfxContent').appendChild(ancfxTable);
            
            // Render AGTHX tab
            const agthxTable = document.createElement('table');
            const agthxHeaders = data.AGTHX.headers;
            
            let agthxHeadersHTML = '<tr>';
            agthxHeaders.forEach(header => {
                agthxHeadersHTML += `<th>${header}</th>`;
            });
            agthxHeadersHTML += '</tr>';
            
            let agthxRowsHTML = '';
            data.AGTHX.distributions.forEach(dist => {
                let rowHTML = '<tr>';
                agthxHeaders.forEach(header => {
                    rowHTML += `<td>${dist[header] || '-'}</td>`;
                });
                rowHTML += '</tr>';
                agthxRowsHTML += rowHTML;
            });
            
            agthxTable.innerHTML = `<thead>${agthxHeadersHTML}</thead><tbody>${agthxRowsHTML}</tbody>`;
            document.getElementById('agthxContent').innerHTML = '';
            document.getElementById('agthxContent').appendChild(agthxTable);
            
            // Render AFAXX tab
            const afaxxTable = document.createElement('table');
            afaxxTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Rate</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.AFAXX.rates.map(rate => `
                        <tr>
                            <td>${rate.rate}</td>
                            <td>${formatDate(rate.date)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            document.getElementById('afaxxContent').innerHTML = '';
            document.getElementById('afaxxContent').appendChild(afaxxTable);
        }

        // Load distribution data from text file
        async function loadDistributions() {
            try {
                const fileUrl = document.getElementById('textFileUrl').value.trim();
                if (!fileUrl) {
                    throw new Error('Please enter a valid URL for the distributions file');
                }
                
                updateLoading(`Loading distribution data from ${fileUrl}...`);
                
                const data = await loadFundDistributionData(fileUrl);
                debugLog.push(`✅ Successfully loaded distribution data.`);
                debugLog.push(`ANCFX: ${data.ANCFX.distributions.length} distributions`);
                debugLog.push(`AGTHX: ${data.AGTHX.distributions.length} distributions`);
                debugLog.push(`AFAXX: ${data.AFAXX.rates.length} rates`);
                
                // Store distribution data globally
                distributionData = data;
                
                // Render tabs with distribution data
                renderDistributionTabs(data);
                
                updateLoading('Distribution data loaded successfully!');
                document.getElementById('debug').textContent = debugLog.join('\n\n');
            } catch (error) {
                debugLog.push(`❌ Error loading distribution data: ${error.message}`);
                document.
