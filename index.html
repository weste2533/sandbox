<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fund Data Loader</title>
    <script src="fund-distribution-parser.js" defer></script> 
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background-color: #f5f5f5; }
        #container { max-width: 1000px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { margin-bottom: 2rem; }
        
        /* Tab Styling */
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1rem; }
        .tab-button { 
            padding: 0.75rem 1.5rem; 
            background-color: #f8f8f8; 
            border: 1px solid #ddd; 
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 0.5rem;
            cursor: pointer;
            font-weight: 500;
        }
        .tab-button.active { 
            background-color: white; 
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: 600;
        }
        .tab-content { display: none; padding: 1rem 0; }
        .tab-content.active { display: block; }
        
        #debug { font-family: monospace; white-space: pre-wrap; background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 4px; max-height: 600px; overflow: auto; margin-bottom: 20px; }
        #data-structure { font-family: monospace; white-space: pre-wrap; background: #f8f8f8; color: #333; padding: 1rem; border-radius: 4px; max-height: 800px; overflow: auto; border: 1px solid #ddd; }
        
        .portfolio-summary { 
            background-color: #f8f8f8; 
            padding: 1.5rem; 
            border-radius: 4px; 
            margin-bottom: 2rem;
            border: 1px solid #eee;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .summary-item {
            padding: 0.75rem;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .summary-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        .summary-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .performance {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }
        .performance.positive {
            background-color: rgba(0, 128, 0, 0.1);
            color: darkgreen;
        }
        .performance.negative {
            background-color: rgba(255, 0, 0, 0.1);
            color: darkred;
        }
        
        .section { margin-bottom: 2rem; }
        .section h2 { margin-top: 0; }
        .section h3 { margin-top: 1.5rem; margin-bottom: 1rem; }
        
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        table th, table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #eee; }
        table th { background-color: #f8f8f8; }
        .error { color: #d32f2f; }
        .controls { margin-top: 1rem; margin-bottom: 1rem; }
        .controls button { 
            padding: 0.5rem 1rem; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .controls button:hover { background-color: #45a049; }
        #last-update { margin-left: 1rem; font-size: 0.9rem; color: #666; }
        
        .daily-activity {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="header">
            <h1>Mutual Fund Data Loader</h1>
            
            <div class="controls">
                <button id="refresh-btn">Refresh Calculations</button>
                <span id="last-update">Last updated: Never</span>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" data-tab="mmf-portfolio">MMF Portfolio</button>
            <button class="tab-button" data-tab="mutual-fund-portfolio">Mutual Fund Portfolio</button>
            <button class="tab-button" data-tab="debug-output">Debug Output</button>
            <button class="tab-button" data-tab="data-structure">Data Structure</button>
        </div>
        
        <!-- MMF Portfolio Tab -->
        <div id="mmf-portfolio" class="tab-content active">
            <div id="mmf-results">Loading MMF portfolio calculations...</div>
        </div>
        
        <!-- Mutual Fund Portfolio Tab -->
        <div id="mutual-fund-portfolio" class="tab-content">
            <div id="mf-results">Loading mutual fund portfolio calculations...</div>
        </div>
        
        <!-- Debug Output Tab -->
        <div id="debug-output" class="tab-content">
            <h2>Debug Output</h2>
            <div id="debug">Debug Output: Loading data...</div>
        </div>
        
        <!-- Data Structure Tab -->
        <div id="data-structure" class="tab-content">
            <h2>Data Structure</h2>
            <div id="data-structure-content">Data structure will appear here once loaded...</div>
        </div>
    </div>

    <script>
        const FUNDS = ['ANCFX', 'AGTHX']; // Removed AFAXX since we only need distribution data for it
        const PROXIES = [
            "https://api.allorigins.win/get?url=",
            "https://corsproxy.io/?", 
            "https://thingproxy.freeboard.io/fetch/",
            "https://cors-anywhere.herokuapp.com/",
            "https://crossorigin.me/",
            "https://yacdn.org/serve/",
            "https://api.codetabs.com/v1/proxy/?quest="
        ];
        let debugLog = [];
        let allFundData = {};

        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Deactivate all tabs
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Activate the clicked tab
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        async function fetchWithRetry(url, maxAttempts = 2) {
            for (let proxyIndex = 0; proxyIndex < PROXIES.length; proxyIndex++) {
                const proxyUrl = PROXIES[proxyIndex] + encodeURIComponent(url);
                
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    try {
                        const start = Date.now();
                        debugLog.push(`ðŸ”µ Proxy ${proxyIndex + 1}/${PROXIES.length} - Attempt ${attempt + 1}/${maxAttempts}\nURL: ${proxyUrl}`);
                        
                        const response = await fetch(proxyUrl, { cache: 'no-cache' });
                        const latency = Date.now() - start;
                        debugLog.push(`Status: ${response.status} â€¢ Latency: ${latency}ms`);

                        if (!response.ok) {
                            throw new Error(`HTTP error: ${response.status}`);
                        }

                        const text = await response.text();
                        try {
                            // Handle allorigins.win specific response format
                            if (proxyUrl.includes('allorigins.win')) {
                                const jsonResponse = JSON.parse(text);
                                if (jsonResponse.contents) {
                                    return JSON.parse(jsonResponse.contents);
                                }
                            }
                            return JSON.parse(text);
                        } catch (e) {
                            debugLog.push(`âš ï¸ JSON parse error: ${e.message}`);
                            return text;
                        }
                    } catch (error) {
                        debugLog.push(`ðŸ”´ Proxy ${proxyIndex + 1} - Attempt ${attempt + 1} error: ${error.message}`);
                        
                        // Only wait if we're going to retry
                        if (attempt < maxAttempts - 1) {
                            const delay = 1000 * (attempt + 1);
                            debugLog.push(`â±ï¸ Waiting ${delay}ms before retry...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                
                // Try next proxy without waiting if all attempts with current proxy failed
            }
            throw new Error('All proxies and retry attempts failed');
        }

        async function fetchYahooFinanceData(fund) {
            const startDate = new Date('2024-01-01');
            const endDate = new Date();
            endDate.setDate(endDate.getDate() - 1);
            const period1 = Math.floor(startDate.getTime() / 1000);
            const period2 = Math.floor(endDate.getTime() / 1000);

            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${fund}?period1=${period1}&period2=${period2}&interval=1d`;

            try {
                const data = await fetchWithRetry(url);
                debugLog.push(`âœ… Fetched ${fund} data from Yahoo Finance.`);
                
                // Log some details about the data structure
                if (data && data.chart && data.chart.result && data.chart.result.length > 0) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp || [];
                    const quotes = result.indicators?.quote?.[0]?.close || [];
                    
                    debugLog.push(`ðŸ“Š ${fund} data: ${timestamps.length} timestamps, ${quotes.length} price points`);
                    return result;
                } else {
                    debugLog.push(`âš ï¸ ${fund} data is incomplete or not in expected format`);
                    console.log("Yahoo Finance data structure:", data);
                    return null;
                }
            } catch (error) {
                debugLog.push(`âš ï¸ Error fetching ${fund} data: ${error.message}`);
                return null;
            }
        }
        
        function updateDebugDisplay() {
            document.getElementById('debug').textContent = debugLog.join('\n\n');
        }
        
        // Function to create a human-readable representation of the data structure
        function displayDataStructure(data) {
            const structureDiv = document.getElementById('data-structure-content');
            
            // Function to create a simplified data representation
            function createDataSummary(data, prefix = '', maxDepth = 3, currentDepth = 0) {
                if (currentDepth >= maxDepth) return prefix + '... (truncated for readability)';
                
                if (data === null) return prefix + 'null';
                if (data === undefined) return prefix + 'undefined';
                
                const type = typeof data;
                
                if (type === 'number' || type === 'boolean' || type === 'string') {
                    // For string values, truncate if too long
                    if (type === 'string' && data.length > 100) {
                        return prefix + `"${data.substring(0, 100)}..." (${data.length} chars)`;
                    }
                    return prefix + JSON.stringify(data);
                }
                
                if (Array.isArray(data)) {
                    if (data.length === 0) return prefix + '[]';
                    
                    // For arrays, show length and sample items
                    let result = prefix + `Array(${data.length}) [\n`;
                    
                    // Show first 3 items, middle item (if applicable), and last item
                    const samplesToShow = Math.min(3, data.length);
                    for (let i = 0; i < samplesToShow; i++) {
                        result += createDataSummary(data[i], prefix + '  ', maxDepth, currentDepth + 1) + ',\n';
                    }
                    
                    // Add middle item if array is large
                    if (data.length > 6) {
                        result += prefix + '  ... more items ...\n';
                    }
                    
                    // Add last item if not already shown
                    if (data.length > samplesToShow) {
                        result += createDataSummary(data[data.length - 1], prefix + '  ', maxDepth, currentDepth + 1) + '\n';
                    }
                    
                    result += prefix + ']';
                    return result;
                }
                
                if (type === 'object') {
                    const keys = Object.keys(data);
                    if (keys.length === 0) return prefix + '{}';
                    
                    let result = prefix + '{\n';
                    
                    // For large objects, limit the number of keys shown
                    const keysToShow = keys.length > 10 ? keys.slice(0, 10) : keys;
                    
                    for (const key of keysToShow) {
                        result += prefix + `  "${key}": ` + 
                                  createDataSummary(data[key], '', maxDepth, currentDepth + 1).trimStart() + ',\n';
                    }
                    
                    if (keys.length > 10) {
                        result += prefix + `  ... ${keys.length - 10} more properties ...\n`;
                    }
                    
                    result += prefix + '}';
                    return result;
                }
                
                return prefix + String(data);
            }
            
            let summary = '';
            
            // Add NAV data summaries
            for (const fund of FUNDS) {
                if (allFundData[fund]) {
                    summary += `=== ${fund} NAV Data ===\n`;
                    
                    // Show a sample of actual values
                    const timestamps = allFundData[fund].timestamp || [];
                    const prices = allFundData[fund].indicators?.quote?.[0]?.close || [];
                    
                    summary += `Total data points: ${timestamps.length}\n`;
                    
                    if (timestamps.length > 0) {
                        summary += '\nSample date/price pairs:\n';
                        
                        // Show first 3, middle, and last data points
                        const sampleIndices = [0, 1, 2];
                        if (timestamps.length > 6) {
                            sampleIndices.push(Math.floor(timestamps.length / 2));
                        }
                        if (timestamps.length > 3) {
                            sampleIndices.push(timestamps.length - 1);
                        }
                        
                        for (const idx of sampleIndices) {
                            if (idx < timestamps.length) {
                                const date = new Date(timestamps[idx] * 1000);
                                const formattedDate = date.toLocaleDateString();
                                summary += `  ${formattedDate}: $${prices[idx]?.toFixed(2) || 'N/A'}\n`;
                            }
                        }
                    }
                    
                    summary += '\n';
                }
            }
            
            // Add distribution data summaries
            if (allFundData.distributions) {
                summary += '=== Distribution Data ===\n';
                
                // AFAXX Rate data
                const afaxxData = allFundData.distributions.AFAXX;
                if (afaxxData && afaxxData.rates) {
                    summary += `\nAFAXX Rate Data: ${afaxxData.rates.length} records\n`;
                    
                    if (afaxxData.rates.length > 0) {
                        summary += 'Sample rates:\n';
                        const samplesToShow = Math.min(3, afaxxData.rates.length);
                        
                        for (let i = 0; i < samplesToShow; i++) {
                            const rate = afaxxData.rates[i];
                            summary += `  ${rate.date || 'Unknown'}: ${rate.rate || 'N/A'}\n`;
                        }
                        
                        if (afaxxData.rates.length > samplesToShow) {
                            summary += `  ... and ${afaxxData.rates.length - samplesToShow} more records\n`;
                        }
                    }
                }
                
                // Distribution data for other funds
                for (const fund of FUNDS) {
                    const fundDist = allFundData.distributions[fund];
                    if (fundDist && fundDist.distributions) {
                        summary += `\n${fund} Distribution Data: ${fundDist.distributions.length} records\n`;
                        
                        // Show headers
                        if (fundDist.headers && fundDist.headers.length > 0) {
                            summary += `Headers: ${fundDist.headers.join(', ')}\n`;
                        }
                        
                        // Show sample distributions
                        if (fundDist.distributions.length > 0) {
                            summary += 'Sample distributions:\n';
                            const samplesToShow = Math.min(3, fundDist.distributions.length);
                            
                            for (let i = 0; i < samplesToShow; i++) {
                                const dist = fundDist.distributions[i];
                                summary += `  Record ${i+1}:\n`;
                                
                                for (const key in dist) {
                                    summary += `    ${key}: ${dist[key]}\n`;
                                }
                            }
                            
                            if (fundDist.distributions.length > samplesToShow) {
                                summary += `  ... and ${fundDist.distributions.length - samplesToShow} more records\n`;
                            }
                        }
                    }
                }
            }
            
            // Add raw data structure
            summary += '\n=== Raw Data Structure ===\n';
            summary += createDataSummary(allFundData);
            
            structureDiv.textContent = summary;
        }

        // Helper function to prepare data for portfolio calculations
        function prepareDataForPortfolioCalculations(allFundData) {
            // Create a new object that has the structure expected by the portfolio calculator
            const portfolioData = {
                distributions: allFundData.distributions
            };
            
            // Incorporate the NAV data in the format expected by calculateMutualFundPortfolio
            for (const fund of FUNDS) {
                if (allFundData[fund]) {
                    portfolioData[fund] = allFundData[fund];
                }
            }
            
            return portfolioData;
        }

        // Function to generate MMF portfolio HTML output
        function generateMMFPortfolioOutput(allFundData) {
            if (!allFundData || !allFundData.distributions) {
                return '<p class="error">Unable to calculate portfolio: Distribution data is missing</p>';
            }
            
            let outputHTML = '<div class="section">';
            outputHTML += '<h2>Money Market Fund Portfolio</h2>';
            
            // Calculate MMF portfolio
            let mmfPortfolio;
            try {
                mmfPortfolio = calculateMMFPortfolio(allFundData, 77650.8, 'AFAXX');
                
                // Portfolio Summary
                outputHTML += '<div class="portfolio-summary">';
                outputHTML += '<h3>Portfolio Summary</h3>';
                outputHTML += '<div class="summary-grid">';
                
                // Starting Value
                outputHTML += '<div class="summary-item">';
                outputHTML += '<div class="summary-label">Initial Investment</div>';
                outputHTML += `<div class="summary-value">$${(77650.8).toFixed(2)}</div>`;
                outputHTML += '</div>';
                
                // Current Value
                outputHTML += '<div class="summary-item">';
                outputHTML += '<div class="summary-label">Current Value</div>';
                outputHTML += `<div class="summary-value">$${mmfPortfolio.currentValue.toFixed(2)}</div>`;
                outputHTML += '</div>';
                
                // Performance
                const performanceClass = mmfPortfolio.totalReturn >= 0 ? 'positive' : 'negative';
                outputHTML += '<div class="summary-item">';
                outputHTML += '<div class="summary-label">Total Return</div>';
                outputHTML += `<div class="summary-value"><span class="performance ${performanceClass}">${mmfPortfolio.totalReturn.toFixed(2)}%</span></div>`;
                outputHTML += '</div>';
                
                outputHTML += '</div>'; // Close summary-grid
                outputHTML += '</div>'; // Close portfolio-summary
                
                // Daily Activity Log
                outputHTML += '<h3>Daily Activity</h3>';
                outputHTML += '<div class="daily-activity">';
                outputHTML += '<table>';
                outputHTML += '<tr><th>Date</th><th>NAV</th><th>Transaction</th><th>Amount</th><th>Balance</th></tr>';
                
                for (const transaction of mmfPortfolio.transactions || []) {
                    outputHTML += `<tr>
                        <td>${transaction.date}</td>
                        <td>$1.00</td>
                        <td>${transaction.type}</td>
                        <td>$${transaction.amount.toFixed(2)}</td>
                        <td>$${transaction.balance.toFixed(2)}</td>
                    </tr>`;
                }
                
                outputHTML += '</table>';
                outputHTML += '</div>'; // Close daily-activity
            } catch (error) {
                outputHTML += `<p class="error">Error calculating MMF portfolio: ${error.message}</p>`;
                console.error("MMF calculation error:", error);
            }
            
            outputHTML += '</div>'; // Close section
            return outputHTML;
        }

        // Function to generate mutual fund portfolio HTML output
        function generateMutualFundPortfolioOutput(allFundData) {
            if (!allFundData || !allFundData.distributions) {
                return '<p class="error">Unable to calculate portfolio: Distribution data is missing</p>';
            }
            
            let outputHTML = '<div class="section">';
            outputHTML += '<h2>Mutual Fund Portfolio</h2>';
            
            // Calculate mutual fund portfolio
            let mutualFundPortfolio;
            try {
                mutualFundPortfolio = calculateMutualFundPortfolio(allFundData, [
                    { symbol: 'ANCFX', initialShares: 1255.196 },
                    { symbol: 'AGTHX', initialShares: 974.753 }
                ]);
                
                // Calculate total values
                let totalInitialValue = 0;
                let totalCurrentValue = 0;
                for (const fund of mutualFundPortfolio.funds || []) {
                    totalInitialValue += fund.initialValue;
                    totalCurrentValue += fund.currentValue;
                }
                const totalReturn = ((totalCurrentValue / totalInitialValue) - 1) * 100;
                
                // Portfolio Summary
                outputHTML += '<div class="portfolio-summary">';
                outputHTML += '<h3>Portfolio Summary</h3>';
                
                // Summary Grid
                outputHTML += '<div class="summary-grid">';
                
                // Starting Value
                outputHTML += '<div class="summary-item">';
                outputHTML += '<div class="summary-label">Initial Investment</div>';
                outputHTML += `<div class="summary-value">$${totalInitialValue.toFixed(2)}</div>`;
                outputHTML += '</div>';
                
                // Current Value
                outputHTML += '<div class="summary-item">';
                outputHTML += '<div class="summary-label">Current Value</div>';
                outputHTML += `<div class="summary-value">$${totalCurrentValue.toFixed(2)}</div>`;
                outputHTML += '</div>';
                
                // Performance
                const performanceClass = totalReturn >= 0 ? 'positive' : 'negative';
                outputHTML += '<div class="summary-item">';
                outputHTML += '<div class="summary-label">Total Return</div>';
                outputHTML += `<div class="summary-value"><span class="performance ${performanceClass}">${totalReturn.toFixed(2)}%</span></div>`;
                outputHTML += '</div>';
                
                outputHTML += '</div>'; // Close summary-grid
                
                // Individual Fund Summary
                outputHTML += '<h4>Fund Details</h4>';
                outputHTML += '<table>';
                outputHTML += '<tr><th>Fund</th><th>Shares</th><th>Initial Value</th><th>Current Value</th><th>Return</th></tr>';
                
                for (const fund of mutualFundPortfolio.funds || []) {
                    const fundPerformanceClass = fund.return >= 0 ? 'positive' : 'negative';
                    outputHTML += `<tr>
                        <td>${fund.symbol}</td>
                        <td>${fund.shares.toFixed(3)}</td>
                        <td>$${fund.initialValue.toFixed(2)}</td>
                        <td>$${fund.currentValue.toFixed(2)}</td>
                        <td><span class="performance ${fundPerformanceClass}">${fund.return.toFixed(2)}%</span></td>
                    </tr>`;
                }
                
                outputHTML += '</table>';
                outputHTML += '</div>'; // Close portfolio-summary
                
                // Generate a combined list of all dates from the timestamps
                const dailyActivity = [];
                const allDates = {};
                
                // Process distribution dates
                for (const distribution of mutualFundPortfolio.distributions || []) {
                    // Convert to Date object for consistent formatting
                    const dateObj = new Date(distribution.date);
                    const dateStr = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD format
                    
                    if (!allDates[dateStr]) {
                        allDates[dateStr] = {
                            date: dateStr,
                            distributions: {}
                        };
                    }
                    
                    // Add this distribution to the correct date
                    if (!allDates[dateStr].distributions[distribution.symbol]) {
                        allDates[dateStr].distributions[distribution.symbol] = [];
                    }
                    
                    allDates[dateStr].distributions[distribution.symbol].push({
                        type: distribution.type,
                        amount: distribution.amount
                    });
                }
                
                // Process NAV data for each fund
                for (const fund of FUNDS) {
                    if (allFundData[fund] && allFundData[fund].timestamp) {
                        const timestamps = allFundData[fund].timestamp;
                        const prices = allFundData[fund].indicators?.quote?.[0]?.close || [];
                        
                        for (let i = 0; i < timestamps.length; i++) {
                            const date = new Date(timestamps[i] * 1000);
                            const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                            
                            if (!allDates[dateStr]) {
                                allDates[dateStr] = {
                                    date: dateStr,
                                    distributions: {}
                                };
                            }
                            
                            // Add NAV data
                            if (!allDates[dateStr].navs) {
                                allDates[dateStr].navs = {};
                            }
                            
                            allDates[dateStr].navs[fund] = prices[i];
                        }
                    }
                }
                
                // Convert object to sorted array
                const sortedDailyActivity = Object.values(allDates).sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                // Daily Activity Log
                outputHTML += '<h3>Daily Activity</h3>';
                outputHTML += '<div class="daily-activity">';
                outputHTML += '<table>';
                outputHTML += '<tr><th>Date</th><th>Fund</th><th>NAV</th><th>Distribution Type</th><th>Distribution Amount</th></tr>';
                
                for (const day of sortedDailyActivity) {
                    let hasDistributions = false;
                    
                    // Check if any fund has distributions on this day
                    for (const fund in day.distributions) {
                        if (day.distributions[fund] && day.distributions[fund].length > 0) {
                            hasDistributions = true;
                            break;
                        }
                    }
                    
                    // If there are distributions for this day, show them
                    if (hasDistributions) {
                        let isFirstRow = true;
                        const rowCount = Object.keys(day.distributions).reduce((count, fund) => 
                            count + day.distributions[fund].length, 0);
                            
                        for (const fund in day.distributions) {
                            for (const dist of day.distributions[fund]) {
                                outputHTML += '<tr>';
                                
                                // Only show date in the first row of this day's distributions
                                if (isFirstRow) {
                                    outputHTML += `<td rowspan="${rowCount}">${formatDateString(day.date)}</td>`;
                                    isFirstRow = false;
                                }
                                
                                outputHTML += `<td>${fund}</td>`;
                                outputHTML += `<td>${day.navs && day.navs[fund] ? '$' + day.navs[fund].toFixed(2) : '-'}</td>`;
                                outputHTML += `<td>${dist.type}</td>`;
                                outputHTML += `<td>$${dist.amount.toFixed(2)}</td>`;
                                outputHTML += '</tr>';
                            }
                        }
                    } 
                    // Otherwise, just show the NAV data
                    else if (day.navs) {
                        let isFirstRow = true;
                        const funds = Object.keys(day.navs);
