<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fund Data Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
            background-color: #f5f5f5;
        }
        #container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #loading {
            text-align: center;
            padding: 1rem;
            color: #666;
        }
        #error {
            color: #dc3545;
            padding: 1rem;
            border: 1px solid #dc3545;
            margin: 1rem 0;
            border-radius: 4px;
            display: none;
        }
        #debug {
            font-family: monospace;
            white-space: pre-wrap;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            max-height: 400px;
            overflow: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
        }
        .action-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
        }
        button {
            padding: 0.5rem 1rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0069d9;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #summary {
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #e9f7fd;
            border-radius: 4px;
            color: #0069d9;
        }
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s;
        }
        /* Tab styles */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px 4px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            color: #333;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #007bff;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            animation: fadeEffect 1s;
        }
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Mutual Fund Data Viewer</h1>
        <div id="loading">üöÄ Loading distribution data...</div>
        <div id="error"></div>
        <div id="summary" style="display:none;"></div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab" id="fundTabs" style="display:none;">
            <button class="tablinks" onclick="openFundTab(event, 'ANCFX')" id="defaultOpen">ANCFX</button>
            <button class="tablinks" onclick="openFundTab(event, 'AGTHX')">AGTHX</button>
            <button class="tablinks" onclick="openFundTab(event, 'AFAXX')">AFAXX</button>
        </div>
        
        <!-- Tab Content -->
        <div id="ANCFX" class="tabcontent">
            <h2>ANCFX Fund Data</h2>
            <table id="ancfxTable">
                <thead id="ancfxTableHead"></thead>
                <tbody id="ancfxTableBody"></tbody>
            </table>
        </div>
        
        <div id="AGTHX" class="tabcontent">
            <h2>AGTHX Fund Data</h2>
            <table id="agthxTable">
                <thead id="agthxTableHead"></thead>
                <tbody id="agthxTableBody"></tbody>
            </table>
        </div>
        
        <div id="AFAXX" class="tabcontent">
            <h2>AFAXX Fund Data</h2>
            <table id="afaxxTable">
                <thead>
                    <tr>
                        <th>Rate</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="afaxxTableBody"></tbody>
            </table>
        </div>
        
        <div id="debug"></div>
        
        <div class="action-buttons" id="buttonContainer" style="display:none;">
            <button id="downloadBtn">Download Data as HTML</button>
        </div>
    </div>

    <script>
        // Debug logging
        let debugLog = [];
        
        function log(message) {
            console.log(message);
            debugLog.push(message);
            document.getElementById('debug').textContent = debugLog.join('\n\n');
        }
        
        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
        }
        
        function showError(message) {
            document.getElementById('error').innerHTML = `‚ùå Error: ${message}`;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
        
        // ---- Functions from fund-distribution-parser.js ----
        
        /**
         * Loads and parses fund distribution data from a text file
         * @param {string} fileUrl - URL of the distributions text file to load
         * @returns {Promise<Object>} - Promise resolving to an object containing the parsed fund data
         */
        function loadFundDistributionData(fileUrl) {
            return new Promise((resolve, reject) => {
                fetch(fileUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch file: ${response.status} ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(data => {
                        const result = parseDistributionData(data);
                        resolve(result);
                    })
                    .catch(error => {
                        reject(error);
                    });
            });
        }

        /**
         * Parses the distribution data text content
         * @param {string} data - Raw text content from the distributions file
         * @returns {Object} - Object containing parsed fund data
         */
        function parseDistributionData(data) {
            const lines = data.trim().split('\n');
            
            let currentFund = null;
            let isHeader = false;
            let headers = [];
            
            const fundData = {
                ANCFX: {
                    distributions: [],
                    headers: []
                },
                AGTHX: {
                    distributions: [],
                    headers: []
                },
                AFAXX: {
                    rates: []
                }
            };
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Skip empty lines
                if (line === '') continue;
                
                // Detect fund
                if (line === 'ANCFX') {
                    currentFund = 'ANCFX';
                    isHeader = true;
                    continue;
                } else if (line === 'AGTHX') {
                    currentFund = 'AGTHX';
                    isHeader = true;
                    continue;
                } else if (line === 'AFAXX') {
                    currentFund = 'AFAXX';
                    isHeader = true;
                    continue;
                }
                
                // Process headers
                if (isHeader) {
                    headers = line.split('\t');
                    if (currentFund === 'ANCFX' || currentFund === 'AGTHX') {
                        fundData[currentFund].headers = headers;
                    }
                    isHeader = false;
                    continue;
                }
                
                // Process data rows
                const values = line.split('\t');
                
                if (currentFund === 'ANCFX' || currentFund === 'AGTHX') {
                    if (values.length === headers.length) {
                        // Create object with header keys and row values
                        const rowObj = {};
                        headers.forEach((header, index) => {
                            rowObj[header] = values[index];
                        });
                        fundData[currentFund].distributions.push(rowObj);
                    }
                } else if (currentFund === 'AFAXX') {
                    if (values.length === 2) {
                        fundData[currentFund].rates.push({
                            rate: values[0],
                            date: values[1]
                        });
                    }
                }
            }
            
            return fundData;
        }

        /**
         * Formats a date string from MM/DD/YY to MM/DD/YYYY
         * @param {string} dateString - Date string in MM/DD/YY format
         * @returns {string} - Formatted date string
         */
        function formatDate(dateString) {
            // Check if date is in MM/DD/YY format and convert to MM/DD/YYYY if needed
            const parts = dateString.split('/');
            if (parts.length === 3 && parts[2].length === 2) {
                const year = parts[2].startsWith('0') ? '20' + parts[2] : '20' + parts[2];
                return `${parts[0]}/${parts[1]}/${year}`;
            }
            return dateString;
        }
        
        // ---- Tab functionality ----
        
        function openFundTab(evt, fundName) {
            // Hide all tab content
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Remove "active" class from all tab buttons
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            // Show the current tab and add "active" class to the button
            document.getElementById(fundName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // ---- Function to render fund data ----
        
        function renderFundData(data) {
            try {
                // Render ANCFX data
                if (data.ANCFX && data.ANCFX.distributions.length > 0) {
                    const headers = data.ANCFX.headers;
                    
                    // Create table header
                    let headerHTML = '<tr>';
                    headers.forEach(header => {
                        headerHTML += `<th>${header}</th>`;
                    });
                    headerHTML += '</tr>';
                    document.getElementById('ancfxTableHead').innerHTML = headerHTML;
                    
                    // Create table rows
                    let rowsHTML = '';
                    data.ANCFX.distributions.forEach(dist => {
                        rowsHTML += '<tr>';
                        headers.forEach(header => {
                            let value = dist[header] || '';
                            
                            // Format dates if applicable
                            if (header.toLowerCase().includes('date')) {
                                value = formatDate(value);
                            }
                            
                            rowsHTML += `<td>${value}</td>`;
                        });
                        rowsHTML += '</tr>';
                    });
                    document.getElementById('ancfxTableBody').innerHTML = rowsHTML;
                    
                    log(`Rendered ${data.ANCFX.distributions.length} ANCFX distributions`);
                }
                
                // Render AGTHX data
                if (data.AGTHX && data.AGTHX.distributions.length > 0) {
                    const headers = data.AGTHX.headers;
                    
                    // Create table header
                    let headerHTML = '<tr>';
                    headers.forEach(header => {
                        headerHTML += `<th>${header}</th>`;
                    });
                    headerHTML += '</tr>';
                    document.getElementById('agthxTableHead').innerHTML = headerHTML;
                    
                    // Create table rows
                    let rowsHTML = '';
                    data.AGTHX.distributions.forEach(dist => {
                        rowsHTML += '<tr>';
                        headers.forEach(header => {
                            let value = dist[header] || '';
                            
                            // Format dates if applicable
                            if (header.toLowerCase().includes('date')) {
                                value = formatDate(value);
                            }
                            
                            rowsHTML += `<td>${value}</td>`;
                        });
                        rowsHTML += '</tr>';
                    });
                    document.getElementById('agthxTableBody').innerHTML = rowsHTML;
                    
                    log(`Rendered ${data.AGTHX.distributions.length} AGTHX distributions`);
                }
                
                // Render AFAXX data
                if (data.AFAXX && data.AFAXX.rates.length > 0) {
                    let rowsHTML = '';
                    data.AFAXX.rates.forEach(rate => {
                        rowsHTML += `<tr>
                            <td>${rate.rate}</td>
                            <td>${formatDate(rate.date)}</td>
                        </tr>`;
                    });
                    document.getElementById('afaxxTableBody').innerHTML = rowsHTML;
                    
                    log(`Rendered ${data.AFAXX.rates.length} AFAXX rates`);
                }
                
                // Update summary
                document.getElementById('summary').innerHTML = `
                    <strong>Fund Data Loaded:</strong>
                    ANCFX: ${data.ANCFX.distributions.length} distributions |
                    AGTHX: ${data.AGTHX.distributions.length} distributions |
                    AFAXX: ${data.AFAXX.rates.length} rates
                `;
                document.getElementById('summary').style.display = 'block';
                
                // Show tabs and hide loading
                document.getElementById('fundTabs').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('buttonContainer').style.display = 'flex';
                
                // Open default tab
                document.getElementById('defaultOpen').click();
                
            } catch (error) {
                showError(`Failed to render fund data: ${error.message}`);
                log(`Error rendering data: ${error.stack}`);
            }
        }
        
        // Download function
        function downloadDataAsHTML() {
            const data = {
                ANCFX: {
                    headers: Array.from(document.querySelectorAll('#ancfxTableHead th')).map(th => th.textContent),
                    rows: Array.from(document.querySelectorAll('#ancfxTableBody tr')).map(row => 
                        Array.from(row.querySelectorAll('td')).map(td => td.textContent)
                    )
                },
                AGTHX: {
                    headers: Array.from(document.querySelectorAll('#agthxTableHead th')).map(th => th.textContent),
                    rows: Array.from(document.querySelectorAll('#agthxTableBody tr')).map(row => 
                        Array.from(row.querySelectorAll('td')).map(td => td.textContent)
                    )
                },
                AFAXX: {
                    headers: ['Rate', 'Date'],
                    rows: Array.from(document.querySelectorAll('#afaxxTableBody tr')).map(row => 
                        Array.from(row.querySelectorAll('td')).map(td => td.textContent)
                    )
                }
            };
            
            const html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fund Distribution Data</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        .info { color: #666; margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; margin-bottom: 40px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Fund Distribution Data</h1>
    <div class="info">
        <p>Generated on: ${new Date().toLocaleString()}</p>
    </div>
    
    <h2>ANCFX Fund Data</h2>
    <table>
        <thead>
            <tr>
                ${data.ANCFX.headers.map(h => `<th>${h}</th>`).join('')}
            </tr>
        </thead>
        <tbody>
            ${data.ANCFX.rows.map(row => `
                <tr>
                    ${row.map(cell => `<td>${cell}</td>`).join('')}
                </tr>
            `).join('')}
        </tbody>
    </table>
    
    <h2>AGTHX Fund Data</h2>
    <table>
        <thead>
            <tr>
                ${data.AGTHX.headers.map(h => `<th>${h}</th>`).join('')}
            </tr>
        </thead>
        <tbody>
            ${data.AGTHX.rows.map(row => `
                <tr>
                    ${row.map(cell => `<td>${cell}</td>`).join('')}
                </tr>
            `).join('')}
        </tbody>
    </table>
    
    <h2>AFAXX Fund Data</h2>
    <table>
        <thead>
            <tr>
                ${data.AFAXX.headers.map(h => `<th>${h}</th>`).join('')}
            </tr>
        </thead>
        <tbody>
            ${data.AFAXX.rows.map(row => `
                <tr>
                    ${row.map(cell => `<td>${cell}</td>`).join('')}
                </tr>
            `).join('')}
        </tbody>
    </table>
</body>
</html>`;
            
            // Create a Blob and download link
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fund_distribution_data.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ---- Initialize the application ----
        
        document.addEventListener('DOMContentLoaded', function() {
            log('Application started');
            updateProgress(10);
            
            // Load the distribution data
            loadFundDistributionData('distributions.txt')
                .then(data => {
                    log('Successfully loaded distribution data');
                    updateProgress(100);
                    renderFundData(data);
                })
                .catch(error => {
                    showError(`Failed to load distribution data: ${error.message}`);
                    log(`Error: ${error.stack}`);
                    updateProgress(100);
                });
                
            // Setup event listeners
            document.getElementById('downloadBtn').addEventListener('click', downloadDataAsHTML);
        });
    </script>
</body>
</html>
