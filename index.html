<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fund Data Loader</title>
    <script src="fund-distribution-parser.js" defer></script> 
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background-color: #f5f5f5; }
        #container { max-width: 1000px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #debug { font-family: monospace; white-space: pre-wrap; background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 4px; max-height: 600px; overflow: auto; margin-bottom: 20px; }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Button Styles */
        .btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        
        .download-btn {
            background-color: #2196F3;
        }
        .download-btn:hover {
            background-color: #0b7dda;
        }
        
        .action-bar {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }
        
        .section {
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Mutual Fund Data Loader</h1>
        
        <!-- Action Buttons -->
        <div class="action-bar">
            <button id="download-button" class="btn download-btn" disabled>Download Data</button>
        </div>
        
        <!-- Debug Output -->
        <h2>Debug Output</h2>
        <div id="debug">Debug Output: Loading data...</div>
        
        <!-- Data Output - All displayed at once -->
        <div id="data-output">
            <!-- Data will be displayed here -->
        </div>
    </div>

    <script>
        const FUNDS = ['ANCFX', 'AGTHX']; // Removed AFAXX since we only need distribution data for it
        const PROXIES = [
            "https://api.allorigins.win/get?url=",
            "https://corsproxy.io/?", 
            "https://thingproxy.freeboard.io/fetch/",
            "https://cors-anywhere.herokuapp.com/",
            "https://crossorigin.me/",
            "https://yacdn.org/serve/",
            "https://api.codetabs.com/v1/proxy/?quest="
        ];
        let debugLog = [];
        let allFundData = {};
        
        // Button event listeners
        document.getElementById('download-button').addEventListener('click', downloadData);

        async function fetchWithRetry(url, maxAttempts = 2) {
            for (let proxyIndex = 0; proxyIndex < PROXIES.length; proxyIndex++) {
                const proxyUrl = PROXIES[proxyIndex] + encodeURIComponent(url);
                
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    try {
                        const start = Date.now();
                        debugLog.push(`üîµ Proxy ${proxyIndex + 1}/${PROXIES.length} - Attempt ${attempt + 1}/${maxAttempts}\nURL: ${proxyUrl}`);
                        
                        const response = await fetch(proxyUrl, { cache: 'no-cache' });
                        const latency = Date.now() - start;
                        debugLog.push(`Status: ${response.status} ‚Ä¢ Latency: ${latency}ms`);

                        if (!response.ok) {
                            throw new Error(`HTTP error: ${response.status}`);
                        }

                        const text = await response.text();
                        try {
                            // Handle allorigins.win specific response format
                            if (proxyUrl.includes('allorigins.win')) {
                                const jsonResponse = JSON.parse(text);
                                if (jsonResponse.contents) {
                                    return JSON.parse(jsonResponse.contents);
                                }
                            }
                            return JSON.parse(text);
                        } catch (e) {
                            debugLog.push(`‚ö†Ô∏è JSON parse error: ${e.message}`);
                            return text;
                        }
                    } catch (error) {
                        debugLog.push(`üî¥ Proxy ${proxyIndex + 1} - Attempt ${attempt + 1} error: ${error.message}`);
                        
                        // Only wait if we're going to retry
                        if (attempt < maxAttempts - 1) {
                            const delay = 1000 * (attempt + 1);
                            debugLog.push(`‚è±Ô∏è Waiting ${delay}ms before retry...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                
                // Try next proxy without waiting if all attempts with current proxy failed
            }
            throw new Error('All proxies and retry attempts failed');
        }

        async function fetchYahooFinanceData(fund) {
            const startDate = new Date('2024-01-01');
            const endDate = new Date();
            endDate.setDate(endDate.getDate() - 1);
            const period1 = Math.floor(startDate.getTime() / 1000);
            const period2 = Math.floor(endDate.getTime() / 1000);

            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${fund}?period1=${period1}&period2=${period2}&interval=1d`;

            try {
                const data = await fetchWithRetry(url);
                debugLog.push(`‚úÖ Fetched ${fund} data from Yahoo Finance.`);
                
                // Log some details about the data structure
                if (data && data.chart && data.chart.result && data.chart.result.length > 0) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp || [];
                    const quotes = result.indicators?.quote?.[0]?.close || [];
                    
                    debugLog.push(`üìä ${fund} data: ${timestamps.length} timestamps, ${quotes.length} price points`);
                    return result;
                } else {
                    debugLog.push(`‚ö†Ô∏è ${fund} data is incomplete or not in expected format`);
                    console.log("Yahoo Finance data structure:", data);
                    return null;
                }
            } catch (error) {
                debugLog.push(`‚ö†Ô∏è Error fetching ${fund} data: ${error.message}`);
                return null;
            }
        }
        
        function updateDebugDisplay() {
            document.getElementById('debug').textContent = debugLog.join('\n\n');
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        // Function to prepare data for download
        function prepareDataForDownload() {
            let csvData = {};
            
            // Prepare NAV data for each fund
            for (const fund of FUNDS) {
                if (!allFundData[fund] || !allFundData[fund].timestamp || !allFundData[fund].indicators?.quote?.[0]?.close) continue;
                
                const timestamps = allFundData[fund].timestamp;
                const prices = allFundData[fund].indicators.quote[0].close;
                let navRows = [];
                
                // Add headers
                navRows.push(['Date', 'NAV', 'Change']);
                
                // Add data rows
                for (let i = 0; i < timestamps.length; i++) {
                    if (prices[i] === null || prices[i] === undefined) continue;
                    
                    const change = i > 0 && prices[i-1] !== null ? 
                        ((prices[i] - prices[i-1]) / prices[i-1] * 100).toFixed(2) + '%' : 'N/A';
                    
                    navRows.push([formatDate(timestamps[i]), `$${prices[i].toFixed(2)}`, change]);
                }
                
                csvData[`${fund}_NAV`] = navRows;
            }
            
            // Prepare distribution data
            const distributionData = allFundData.distributions;
            if (distributionData) {
                // AFAXX rates
                if (distributionData.AFAXX && distributionData.AFAXX.rates) {
                    const rates = distributionData.AFAXX.rates;
                    let rateRows = [['Date', 'Rate']];
                    
                    rates.forEach(item => {
                        rateRows.push([item.date || 'Unknown', item.rate || 'N/A']);
                    });
                    
                    csvData['AFAXX_Rates'] = rateRows;
                }
                
                // Distribution data for other funds
                for (const fund of FUNDS) {
                    if (!distributionData[fund] || !distributionData[fund].distributions) continue;
                    
                    const distributions = distributionData[fund].distributions;
                    const headers = distributionData[fund].headers || [];
                    
                    let distRows = [headers];
                    
                    distributions.forEach(dist => {
                        let row = [];
                        headers.forEach(header => {
                            row.push(dist[header] || 'N/A');
                        });
                        distRows.push(row);
                    });
                    
                    csvData[`${fund}_Distributions`] = distRows;
                }
            }
            
            return csvData;
        }
        
        // Function to download data as CSV
        function downloadData() {
            const data = prepareDataForDownload();
            const fundNames = Object.keys(data);
            
            if (fundNames.length === 0) {
                alert('No data available to download.');
                return;
            }
            
            // Create a zip file with multiple CSVs
            const zip = new JSZip();
            
            // Add each fund's data as a separate CSV file
            for (const fundName of fundNames) {
                const rows = data[fundName];
                let csvContent = rows.map(e => e.join(',')).join('\n');
                zip.file(`${fundName}.csv`, csvContent);
            }
            
            // Generate the zip file
            zip.generateAsync({type:"blob"})
                .then(function(content) {
                    // Create a download link
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = 'fund_data.zip';
                    link.click();
                });
        }

        async function loadAllFundsData() {
            debugLog.push("üöÄ Starting data retrieval...");
            updateDebugDisplay();

            // Fetch NAV data for funds (excluding AFAXX)
            for (let fund of FUNDS) {
                debugLog.push(`üìä Fetching NAV data for ${fund}...`);
                updateDebugDisplay();
                let result = await fetchYahooFinanceData(fund);
                if (result) {
                    allFundData[fund] = result;
                    debugLog.push(`‚úÖ Successfully loaded NAV data for ${fund}`);
                }
                updateDebugDisplay();
            }

            // Load distributions (including AFAXX)
            try {
                debugLog.push(`üìä Loading distribution data...`);
                updateDebugDisplay();
                const distributions = await loadFundDistributionData('distributions.txt');
                
                if (!distributions) {
                    debugLog.push(`‚ö†Ô∏è Distribution data is null or undefined`);
                } else {
                    debugLog.push(`‚úÖ Successfully loaded distributions from distributions.txt.`);
                    allFundData['distributions'] = distributions;
                    
                    // Log what funds we have distribution data for
                    const fundKeys = Object.keys(distributions);
                    debugLog.push(`üìà Found distribution data for: ${fundKeys.join(', ')}`);
                    
                    // Check each fund for specific data structure
                    if (distributions.AFAXX && distributions.AFAXX.rates) {
                        debugLog.push(`AFAXX: ${distributions.AFAXX.rates.length} rate records found`);
                    } else {
                        debugLog.push(`AFAXX: No valid rate records found`);
                    }
                    
                    for (const fund of FUNDS) {
                        if (distributions[fund] && distributions[fund].distributions) {
                            debugLog.push(`${fund}: ${distributions[fund].distributions.length} distribution records found`);
                        } else {
                            debugLog.push(`${fund}: No valid distribution records found`);
                        }
                    }
                }
            } catch (error) {
                debugLog.push(`‚ö†Ô∏è Error loading distributions: ${error.message}`);
                console.error("Distribution loading error:", error);
            }
            
            // Enable download button
            document.getElementById('download-button').disabled = false;
            
            // Update debug display with final summary
            debugLog.push(`‚úÖ Data retrieval complete. Click "Download Data" to save all fund data.`);
            updateDebugDisplay();
            
            // Log the complete data object for debugging
            console.log('All fund data:', allFundData);
        }

        // Add JSZip library for zip file creation
        function loadJSZip() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function init() {
            try {
                await loadJSZip();
                await loadAllFundsData();
            } catch (error) {
                debugLog.push(`‚ö†Ô∏è Initialization error: ${error.message}`);
                updateDebugDisplay();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
